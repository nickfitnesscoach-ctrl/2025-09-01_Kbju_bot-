# aiogram_sqla_sample

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø—Ä–∏–º–µ—Ä Telegram-–±–æ—Ç–∞, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ **aiogram** (v3) –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ **SQLAlchemy** (v2) –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —á–∞—Å—Ç—å —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞–º–∏ –±–æ—Ç–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n webhook
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- Python 3.12
- aiogram 3.22.0
- SQLAlchemy 2.0.30
- Flask 3.0.3
- Gunicorn 22.0.0

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# –∏–ª–∏
venv\Scripts\activate  # Windows
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ [.env.example](.env.example) –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º –¥–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
TELEGRAM_BOT_TOKEN=–≤–∞—à_–±–æ—Ç_—Ç–æ–∫–µ–Ω
ADMIN_CHAT_ID=–≤–∞—à_Telegram_ID
```

–ï—Å–ª–∏ `TELEGRAM_BOT_TOKEN` –Ω–µ —É–∫–∞–∑–∞–Ω, –±–æ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–∞–±–æ—Ç—É —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `ADMIN_CHAT_ID` –∞–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã.

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ `.env` –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å.

### –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

–í –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω Makefile —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Telegram-–±–æ—Ç–∞
make run-bot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-–∞–¥–º–∏–Ω–∫—É
make run-admin
```

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞–ø—Ä—è–º—É—é:

```bash
python run.py
python start_admin_panel.py
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:8080. –î–ª—è –≤—Ö–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–æ–ª—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `ADMIN_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`).

## Docker

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ Docker –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```bash
docker-compose up -d
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `TELEGRAM_BOT_TOKEN` ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è).
- `ADMIN_CHAT_ID` ‚Äî –≤–∞—à Telegram ID –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞-—Ñ–∏—á–∞–º –∏ –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞–º.
- `DB_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é SQLite).
- `ADMIN_PASSWORD` ‚Äî –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `admin`).
- `SECRET_KEY` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è Flask-—Å–µ—Å—Å–∏–π.
- `N8N_WEBHOOK_URL` / `N8N_WEBHOOK_SECRET` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å n8n (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
- `ENABLE_DRIP_FOLLOWUPS`, `DRIP_CHECK_INTERVAL_SEC`, `DRIP_24H_MIN`, `DRIP_48H_MIN`, `DRIP_72H_MIN` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–æ–≥–æ–Ω—è—é—â–∏—Ö –∫–µ–π—Å–æ–≤ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –≤ –±–æ—Ç–µ

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `ADMIN_CHAT_ID` –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ª–∏–¥–æ–≤ –ø—Ä—è–º–æ –≤ Telegram:

- `/all_leads` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–ø–æ 10 –∫–∞—Ä—Ç–æ—á–µ–∫). –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é –æ –Ω–æ–≤–æ–º –ª–∏–¥–µ.
- `/all_leads 2` ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
- `/all_leads_today` –∏–ª–∏ `/all_leads_7d` ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–∏–¥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –∏–ª–∏ 7 –¥–Ω–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

–ü–æ—Å–ª–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ–π–¥–∂–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ ¬´‚óÄÔ∏è –ù–∞–∑–∞–¥¬ª, ¬´‚ñ∂Ô∏è –î–∞–ª–µ–µ¬ª, ¬´üîÑ –û–±–Ω–æ–≤–∏—Ç—å¬ª –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏. –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü.

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ

1. –£–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π Telegram ID –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `ADMIN_CHAT_ID` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.
2. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ –ª–∏—á–∫—É —Å —ç—Ç–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/set_coach_photo` –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏.
3. –ü—Ä–∏—à–ª–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º ‚Äî –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ–º `file_id: ...` –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.
4. –ö–æ–º–∞–Ω–¥–∞ `/photo_id` –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ –ø–æ–∫–∞–∂–µ—Ç –µ–≥–æ `file_id` –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.

–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π `file_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤ `/start`, –ø–æ—ç—Ç–æ–º—É –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

## DRIP follow-ups: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞

–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –¥–æ–≥–æ–Ω—è—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –í `.env` –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–¥–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:

   ```env
   ENABLE_DRIP_FOLLOWUPS=true
   DRIP_CHECK_INTERVAL_SEC=5
   DRIP_24H_MIN=1
   DRIP_48H_MIN=2
   DRIP_72H_MIN=3
   ```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ (`make run-bot` –∏–ª–∏ `python run.py`). –í –ª–æ–≥–∞—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è –±–ª–æ–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ DRIP, PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —Å—Ç–∞—Ç—É—Å–æ–º –≤–æ—Ä–∫–µ—Ä–∞.
3. –°—ã–º–∏—Ç–∏—Ä—É–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ–π–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∏–ª–∏ –≤–µ—Ç–∫—É —Å–æ–≤–µ—Ç–æ–≤), –∑–∞—Ç–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã –≤–æ—Ä–∫–µ—Ä —Å–º–æ–≥ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
4. –í –ª–æ–≥–∞—Ö –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Ü–∏–∫–ª –≤–æ—Ä–∫–µ—Ä–∞:
   - `DRIP scan start ...` ‚Äî –Ω–∞—á–∞–ª–æ –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π –∏ –∑–∞–ø—Ä–æ—Å–æ–º –≤—ã–±–æ—Ä–∫–∏.
   - `DRIP candidate ...` –∏ `DRIP evaluation ...` ‚Äî –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∫–æ–≥–æ—Ä—Ç–µ.
   - `DRIP stage stats ...` ‚Äî –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç—É–ø–µ–Ω—è–º (24h/48h/72h) –∏ —Ñ–∞–∫—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏.
5. –ö–æ–≥–¥–∞ –ø—Ä–æ–π–¥—É—Ç –ø–æ—Ä–æ–≥–æ–≤—ã–µ –º–∏–Ω—É—Ç—ã (1/2/3), –≤–æ—Ä–∫–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –æ–±–Ω–æ–≤–∏—Ç `drip_stage` –≤ –ë–î. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ø—Ä–∏—á–∏–Ω—ã –≤ –ª–æ–≥–∞—Ö (`reason=...`), —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —É—Å–ª–æ–≤–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∏—Å–∫–ª—é—á—ë–Ω.
