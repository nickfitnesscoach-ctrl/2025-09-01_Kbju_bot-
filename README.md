# aiogram_sqla_sample

Этот проект представляет собой пример Telegram-бота, разработанного с использованием фреймворка **aiogram** (v3) и библиотеки **SQLAlchemy** (v2) для асинхронных операций с базой данных.

## Основные функции

- Пользовательская часть через Telegram-бот
- Админ-панель с веб-интерфейсом для управления текстами бота
- Интеграция с n8n webhook
- Асинхронная работа с базой данных SQLite

## Технический стек

- Python 3.12
- aiogram 3.22.0
- SQLAlchemy 2.0.30
- Flask 3.0.3
- Gunicorn 22.0.0

## Установка и запуск

### Подготовка виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### Настройка окружения

Создайте файл `.env` на основе [.env.example](.env.example) и заполните минимум две переменные:

```env
TELEGRAM_BOT_TOKEN=ваш_бот_токен
ADMIN_CHAT_ID=ваш_Telegram_ID
```

Если `TELEGRAM_BOT_TOKEN` не указан, бот завершит работу с понятным сообщением. При отсутствии `ADMIN_CHAT_ID` админ-функции будут ограничены.

### Быстрый запуск

В проекте добавлен Makefile с командами для запуска бота и админ-панели:

```bash
# Запустить Telegram-бота
make run-bot

# Запустить веб-админку
make run-admin
```

Также можно запускать скрипты напрямую:

```bash
python run.py
python start_admin_panel.py
```

После запуска админ-панель будет доступна по адресу: http://localhost:8080. Для входа используйте пароль из переменной `ADMIN_PASSWORD` (по умолчанию `admin`).

## Docker

Для запуска в Docker используйте:

```bash
docker-compose up -d
```

## Конфигурация

Основные переменные окружения:

- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота (обязательная).
- `ADMIN_CHAT_ID` — ваш Telegram ID для доступа к медиа-фичам и админ-командам.
- `DB_URL` — строка подключения к базе данных (по умолчанию SQLite).
- `ADMIN_PASSWORD` — пароль для доступа к админ-панели (по умолчанию: `admin`).
- `SECRET_KEY` — секретный ключ для Flask-сессий.
- `N8N_WEBHOOK_URL` / `N8N_WEBHOOK_SECRET` — параметры интеграции с n8n (опционально).

## Обновление приветственного фото

1. Укажите свой Telegram ID в переменной `ADMIN_CHAT_ID` и перезапустите бота.
2. Напишите боту в личку с этого аккаунта и отправьте команду `/set_coach_photo` для подсказки.
3. Пришлите новое фото одним сообщением — бот ответит сообщением `file_id: ...` и сохранит значение.
4. Команда `/photo_id` в ответ на любое сообщение с фото покажет его `file_id` для ручной проверки.

Сохранённый `file_id` используется при отправке приветственного фото в `/start`, поэтому повторные запросы работают мгновенно.